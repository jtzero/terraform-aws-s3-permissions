#!/usr/bin/env bash

set -Eeuo pipefail

echo "ğŸ§ª Running Terraform tests for terraform-aws-s3-permissions module..."
echo

SCRIPTS_DIR="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"
TEST_DIR="$(dirname "${SCRIPTS_DIR}")/tests"
cd "${TEST_DIR}"

echo "ğŸ“¦ Initializing Terraform..."
terraform init -upgrade

echo "âœ… Validating Terraform configuration..."
terraform validate

echo "ğŸ” Running Terraform plan to see test results..."
terraform plan -detailed-exitcode

case $? in
0)
  echo "âœ… All tests passed! No changes detected."
  ;;
1)
  echo "âŒ Terraform plan failed. Check the configuration."
  exit 1
  ;;
2)
  echo "âš ï¸  Plan shows changes. This is expected for the test IAM policies."
  echo "ğŸ“Š Check the output validation results above for detailed test results."
  ;;
esac

echo
echo "ğŸ¯ Test Summary:"
echo "   - Validation: Check 'test_validation_summary' output for overall results"
echo "   - Details: Check 'content_validation_results' output for specific validations"
echo "   - Example: The plan shows IAM policies will be created to demonstrate usage"
echo
echo "ğŸ’¡ To see the actual values being tested, run: terraform output"
echo "ğŸ’¡ To apply the test resources (IAM policies), run: terraform apply"
